//~~WEBPATH~~/vz-projector/knn.js
function Uc(a,b,c){function d(h){Fc("Finding nearest neighbors: "+(100*t).toFixed()+"%",function(){for(var d=u<r?p+1:p,h=new Float32Array(d*g),m=0;m<d;++m)for(var v=c(a[n+m]),E=0;E<g;++E)h[m*g+E]=v[E];m=new weblas.pipeline.Tensor([d,g],h);v=weblas.pipeline.sgemm(1,k,m,null,null);h=v.transfer();m.delete();v.delete();t+=q;for(m=0;m<d;m++){for(var v=new Xb(b),E=n+m,C=0;C<e;C++)if(C!==E){var D=1-h[C*d+m];v.add(D,{index:C,dist:D})}l[E]=v.getMinKItems()}t+=q;n+=d;u++},"knn-gpu").then(function(){u<m?d(h):
(Y(null,"knn-gpu"),k.delete(),h(l))},function(){Y(null,"knn-gpu");Vc(a,b,c,function(a,b){return 1-Jc(a,b)}).then(function(a){h(a)})})}var e=a.length,g=c(a[0]).length,h=Tc(a,c),k=new weblas.pipeline.Tensor([e,g],h),l=Array(e),m=Math.ceil(e/256),p=Math.floor(e/m),r=e%m,n=0,t=0,q=1/(2*m),u=0;return new Promise(function(a){return d(a)})}
function Vc(a,b,c,d){return Fc("Finding nearest neighbors...",function(){for(var e=a.length,g=Array(e),h=Array(e),k=0;k<e;k++)h[k]=new Xb(b);for(k=0;k<e;k++)for(var l=c(a[k]),m=h[k],p=k+1;p<e;p++){var r=h[p],n=m.getSize()===b?m.getLargestKey()||Number.MAX_VALUE:Number.MAX_VALUE,t=r.getSize()===b?r.getLargestKey()||Number.MAX_VALUE:Number.MAX_VALUE,n=Math.max(n,t),n=d(l,c(a[p]),n);0<=n&&(m.add(n,{index:p,dist:n}),r.add(n,{index:k,dist:n}))}for(k=0;k<e;k++)g[k]=h[k].getMinKItems();return g})}
function Wc(a,b,c,d,e){c=new Xb(c);for(var g=d(a[b]),h=0;h<a.length;++h)if(h!==b){var k=d(a[h]),k=e(g,k);c.add(k,{index:h,dist:k})}return c.getMinKItems()};